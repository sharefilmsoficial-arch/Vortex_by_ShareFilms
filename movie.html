<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pel√≠cula</title>
<link rel="stylesheet" href="style.css">
</head>
<body class="movie-page">

<div id="app">

  <div class="back-btn">
  <a href="#" onclick="goBack(event)">‚Üê Volver</a>
  </div>

  <div class="movie-hero" id="hero">
    <div id="videoContainer">

      <video id="bgVideo" autoplay muted playsinline></video>
    </div>

    <div class="overlay"></div>

    <div class="controls">
      <h1 id="title"></h1>
      <p id="meta"></p>
      <p id="description" style="margin-top:12px;opacity:0.85;font-size:16px;"></p>

      <div class="action-row">
        <button id="playMovie" class="big">Reproducir pel√≠cula</button>

        <div class="small-controls">
          <button id="likeBtn" class="icon">
                <img id="likeIcon" src="icons/un-like.png" style="width:22px;vertical-align:middle;">
                 <span id="likeCount">0</span>
          </button>

          <button id="dislikeBtn" class="icon">
                <img id="dislikeIcon" src="icons/un-dislike.png" style="width:22px;vertical-align:middle;">
                <span id="dislikeCount">0</span>
          </button>

          <button id="playTrailerBtn" class="icon">‚ñ∂Tr√°iler</button>
          <button id="toggleMute" class="icon"> 
                    <img id="muteIcon" src="icons/vol.png" style="width:22px;vertical-align:middle;">
          </button>

          <button id="shareBtn" class="icon">
                   <img src="icons/share.png" style="width:22px;vertical-align:middle;">
          </button>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- MODAL PARA COMPARTIR -->
<div id="shareModal" class="share-modal">
    <div class="share-content">
        <span class="close-share" onclick="closeShareMenu()">‚úï</span>

        <h3>Compartir en</h3>

        <div class="share-options">
            <div id="copyLink" class="copy-option">
                <div class="share-icon">
                    <img src="icons/clipboard.png">
                </div>
                     Copiar link
            </div>

            <a id="shareWhatsapp" target="_blank">
                <div class="share-icon">
                    <img src="https://cdn-icons-png.flaticon.com/512/733/733585.png">
                </div>
                WhatsApp
            </a>
            <a id="shareFacebook" target="_blank">
              <div class="share-icon">
                <img src="https://cdn-icons-png.flaticon.com/512/733/733547.png">
              </div>
                    Facebook
            </a>

        </div>
    </div>
</div>

<script src="movies.js"></script>
<script src="amazon-prime/publicidad.js"></script>

<script>
function goBack(e) {
  e.preventDefault();

  // Si existe historial real
  if (window.history.length > 1) {
    window.history.back();
  } else {
    // Fallback seguro
    window.location.href = "index.html";
  }
}
</script>

<script>
/* user id */
const userId = localStorage.getItem("sf_user_id") || ('u_' + Math.random().toString(36).slice(2));
localStorage.setItem("sf_user_id", userId);

function qs(q){return document.querySelector(q);}
function qsa(q){return document.querySelectorAll(q);}

const params = new URLSearchParams(location.search);
const id = params.get('id');
const movie = MOVIES.find(m=>m.id===id);

if(!movie){
  document.body.innerHTML = '<p>Pelicula no encontrada. <a href="index.html">Volver</a></p>';
  throw new Error('Movie not found');
}

qs('#title').textContent = movie.title;
qs('#meta').textContent = `${movie.year || ''} ‚Ä¢ ${movie.duration || ''} ‚Ä¢ Clasificaci√≥n: ${movie.rating || ''} ‚Ä¢ Calidad: ${movie.calidad || ''} ‚Ä¢ G√©neros: ${movie.genres || ''}`;
qs('#description').textContent = movie.description || "Sin descripci√≥n disponible.";

// Definir bgVideo y toggleMute en scope global
const bgVideo = document.getElementById("bgVideo");
const toggleMute = qs('#toggleMute');
const playTrailerBtn = document.getElementById("playTrailerBtn");

// üé¨ Reproducir tr√°iler de fondo autom√°ticamente a los 5 segundos
setTimeout(() => {
  if (!movie.trailerUrl) return;

  bgVideo.style.display = "block";
  bgVideo.src = movie.trailerUrl;
  bgVideo.muted = true;
  bgVideo.currentTime = 0;

  bgVideo.play().catch(e => console.warn("Autoplay bloqueado:", e));

  bgVideo.onended = restorePoster;
}, 6000);

// ‚ñ∂ Bot√≥n para reproducir SOLO el tr√°iler
playTrailerBtn.addEventListener("click", () => {
  if (!movie.trailerUrl) return;

  bgVideo.style.display = "block";
  bgVideo.src = movie.trailerUrl;
  bgVideo.muted = false;
  bgVideo.currentTime = 0;

  bgVideo.play();
  bgVideo.onended = restorePoster;

});


// Fondo est√°tico si no hay tr√°iler
const hero = qs('#hero');
if (movie.post) {
  hero.style.backgroundImage = `url(${movie.post})`;
  hero.style.backgroundSize = "cover";
  hero.style.backgroundPosition = "center";
} else {
  hero.classList.add('no-video');
}
function restorePoster() {
  bgVideo.pause();
  bgVideo.currentTime = 0;
  bgVideo.src = "";              // quita el video
  bgVideo.style.display = "none"; // oculta el video
}

// üîá Bot√≥n mute/unmute
const muteIcon = document.getElementById("muteIcon");

toggleMute.addEventListener('click', () => {
  bgVideo.muted = !bgVideo.muted;

  // Cambiar imagen seg√∫n mute/unmute
  muteIcon.src = bgVideo.muted ? "icons/vol.png" : "icons/mudo.png";
});

const shareBtn = document.getElementById("shareBtn");
shareBtn.addEventListener("click", openShareMenu);

function openShareMenu() {
    const modal = document.getElementById("shareModal");
    modal.style.display = "flex";

    const url = encodeURIComponent(window.location.href);

    document.getElementById("shareWhatsapp").href =
        "https://wa.me/?text=" + url;

    document.getElementById("shareFacebook").href =
        "https://www.facebook.com/sharer/sharer.php?u=" + url;
}


function closeShareMenu() {
    document.getElementById("shareModal").style.display = "none";
}

document.getElementById("copyLink").addEventListener("click", () => {
    const url = window.location.href;

    navigator.clipboard.writeText(url)
        .then(() => {
            alert("‚úî Enlace copiado al portapapeles");
            closeShareMenu();
        })
        .catch(err => {
            console.error("Error al copiar:", err);
            alert("No se pudo copiar el enlace");
        });
});

document.getElementById("shareFacebook").addEventListener("click", () => {
    const url = encodeURIComponent(window.location.href);

    // URL de compartir en Facebook
    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;

    window.open(facebookUrl, "_blank");
});

 
// ‚ñ∂ Reproducir pel√≠cula
qs('#playMovie').addEventListener('click', ()=>{
  if(movie.movie && movie.movie.startsWith('http')){
    window.open(movie.movie, '_blank');
  } else {
    alert('Pel√≠cula no disponible.');
  }
});

//üëçüëé Likes y dislikes
function applyVoteVisual() {
  // Like
  likeIcon.src = state.userVote === 1 
    ? "icons/like.png"        // activo
    : "icons/un-like.png";    // desactivado

  // Dislike
  dislikeIcon.src = state.userVote === -1
    ? "icons/dislike.png"     // activo (lo puedes cambiar si tienes icono distinto)
    : "icons/un-dislike.png";       // desactivado (idem)
}
const likeCountEl = qs('#likeCount');
const dislikeCountEl = qs('#dislikeCount');

let state = { userVote: 0 }; // 1=like, -1=dislike, 0=none

async function fetchVotes(){
  try{
    const res = await fetch(`api/get_votes.php?id=${movie.id}`);
    const data = await res.json();

    likeCountEl.textContent = data.likes || 0;
    dislikeCountEl.textContent = data.dislikes || 0;

    const r2 = await fetch(`api/get_user_vote.php?id=${movie.id}&user=${userId}`);
    const uv = await r2.json();

    state.userVote = uv.vote || 0;
    applyVoteVisual();
  } catch(e){ console.error(e); }
}

async function sendVote(vote){
  try{
    const res = await fetch("api/vote.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        movie_id: movie.id,
        user: userId,
        vote: vote
      })
    });

    const out = await res.json();

    likeCountEl.textContent = out.likes;
    dislikeCountEl.textContent = out.dislikes;

    state.userVote = vote;
    applyVoteVisual();
  } catch(e){
    console.error("Error enviando voto", e);
  }
}

function applyVoteVisual(){
  likeBtn.style.opacity = state.userVote===1 ? "1" : "0.6";
  dislikeBtn.style.opacity = state.userVote===-1 ? "1" : "0.6";
}

likeBtn.addEventListener('click', ()=>{ state.userVote===1 ? sendVote(0) : sendVote(1); });
dislikeBtn.addEventListener('click', ()=>{ state.userVote===-1 ? sendVote(0) : sendVote(-1); });

fetchVotes();
</script>

<hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin:20px 32px;">

<section class="comments" id="commentsSection" style="padding:0 32px 40px;max-width:900px">
  <h2>Comentarios</h2>

  <div id="commentsList" aria-live="polite"></div>

  <div style="margin-top:12px">
    <input id="commentName" placeholder="Tu nombre (opcional)" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);width:40%;margin-right:8px" />
    <textarea id="commentText" placeholder="Deja un comentario..." style="width:100%;min-height:72px;margin-top:8px;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06)"></textarea>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="submitComment" class="big">Comentar</button>
      <button id="clearComments" class="icon">üßπ Limpiar</button>
    </div>
  </div>

  <h3>Ap√≥yanos con una donaci√≥n </h3>
<form action="https://www.paypal.com/donate" method="post" target="_top">
<input type="hidden" name="hosted_button_id" value="TU_CODIGO_DE_PAYPAL" />
 <input type="submit" value="Donar" />
</form>
  
</section>

<script>
const commentsList = document.getElementById('commentsList');
const commentName = document.getElementById('commentName');
const commentText = document.getElementById('commentText');
const submitComment = document.getElementById('submitComment');
const clearComments = document.getElementById('clearComments');

commentName.value = localStorage.getItem('sf_user_name') || '';

async function loadComments(){
  try{
    const res = await fetch(`api/get_comments.php?id=${movie.id}`);
    const data = await res.json();

    commentsList.innerHTML = "";

    if(!Array.isArray(data) || data.length === 0){
      commentsList.innerHTML = '<p style="opacity:0.7">Sin comentarios. S√© el primero.</p>';
      return;
    }

    data.forEach(c=>{
      const el = document.createElement('div');
      el.className = 'comment';
      el.style.padding='8px 12px';
      el.style.borderRadius='8px';
      el.style.marginBottom='8px';
      el.style.background='rgba(255,255,255,0.02)';

      el.innerHTML = `
        <strong>Usuario #${escapeHtml(c.usuario_id || "0")}</strong>
        <span style="opacity:0.6;font-size:12px;margin-left:8px">${escapeHtml(c.fecha || "")}</span>
        <div style="margin-top:6px">${escapeHtml(c.comentario || "")}</div>
      `;

      commentsList.appendChild(el);
    });

  } catch(e){
    console.error("Error cargando comentarios", e);
  }
}

function escapeHtml(s){ 
  if(!s) return ''; 
  return s.replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;'); 
}

submitComment.addEventListener('click', async ()=>{
  const name = commentName.value.trim();
  const text = commentText.value.trim();
  if(!text){ alert('Escribe un comentario'); return; }
  localStorage.setItem('sf_user_name', name);

  try{
    const res = await fetch("api/add_comment.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        movie_id: movie.id,
        name: name,
        text: text
      })
    });

    const data = await res.json();

    if(data.success){
      commentText.value='';
      loadComments();
    }
    else {
      alert('No se pudo guardar el comentario');
    }
  }catch(e){
    console.error(e);
    alert('Error al enviar');
  }
});

clearComments.addEventListener('click', async ()=>{
  if(!confirm('¬øEliminar todos los comentarios de esta pel√≠cula?')) return;

  try{
    const res = await fetch("api/clear_comments.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ movie_id: movie.id })
    });

    const data = await res.json();
    if(data.success) loadComments();
  }catch(e){
    console.error(e);
  }
});

loadComments();
</script>

<section id="relatedSection" style="padding:32px; margin-top:40px;">
  <h2 style="margin-bottom:16px;">Tambi√©n te podr√≠a interesar</h2>

  <div class="carousel-container">
    <div class="carousel-track" id="relatedCarousel"></div>

    <button class="carousel-btn prev">‚ùÆ</button>
    <button class="carousel-btn next">‚ùØ</button>
  </div>
</section>

<script>
// =============================
// üé¨ CARRUSEL - PEL√çCULAS SIGUIENTES
// =============================

// Encontrar √≠ndice de la pel√≠cula actual
const currentIndex = MOVIES.findIndex(m => m.id === movie.id);

// Si no la encuentra, evita error
let related = [];
if (currentIndex !== -1) {
  for (let i = currentIndex + 1; i < MOVIES.length; i++) {
    related.push(MOVIES[i]);
  }

  // Si quieres que contin√∫e desde el inicio cuando se acaben
  for (let i = 0; i < currentIndex; i++) {
    related.push(MOVIES[i]);
  }
}

// Limitar cu√°ntas mostrar
related = related.slice(0, 15);


// Crear tarjetas
const track = document.getElementById("relatedCarousel");

related.forEach(m => {
  const item = document.createElement("div");
  item.className = "carousel-item";
  item.innerHTML = `
    <img src="${m.post || m.image}" alt="${m.title}">
    <span>${m.title}</span>
  `;
  item.addEventListener("click", () => {
    window.location.href = "movie.html?id=" + m.id;
  });
  track.appendChild(item);
});

// =============================
// üé° L√ìGICA DEL CARRUSEL
// =============================
let position = 0;
const cardWidth = 165; // card + gap

const btnPrev = document.querySelector(".carousel-btn.prev");
const btnNext = document.querySelector(".carousel-btn.next");

btnNext.addEventListener("click", () => moveCarousel(-cardWidth));
btnPrev.addEventListener("click", () => moveCarousel(cardWidth));

function moveCarousel(amount) {
  position += amount;

  const maxScroll = -(cardWidth * (related.length - 5));

  if (position < maxScroll) position = 0;          // loop
  if (position > 0) position = maxScroll;         // loop

  track.style.transform = `translateX(${position}px)`;
}

// =============================
// üîÅ AUTO-DESPLAZAMIENTO
// =============================
let autoScroll = setInterval(() => moveCarousel(-cardWidth), 3000);

// Pausar al pasar el mouse
document.querySelector(".carousel-container")
  .addEventListener("mouseenter", () => clearInterval(autoScroll));

document.querySelector(".carousel-container")
  .addEventListener("mouseleave", () => {
    autoScroll = setInterval(() => moveCarousel(-cardWidth), 3000);
  });

// =============================
// üì± DESLIZAR CON EL DEDO O MOUSE
// =============================
let startX = 0;

track.addEventListener("touchstart", e => startX = e.touches[0].clientX);
track.addEventListener("touchend", e => {
  let endX = e.changedTouches[0].clientX;
  if (endX < startX - 40) moveCarousel(-cardWidth);
  if (endX > startX + 40) moveCarousel(cardWidth);
});

// Mouse
track.addEventListener("mousedown", e => startX = e.clientX);
track.addEventListener("mouseup", e => {
  let endX = e.clientX;
  if (endX < startX - 40) moveCarousel(-cardWidth);
  if (endX > startX + 40) moveCarousel(cardWidth);
});
</script>
<section id="gallerySection" style="padding:32px; margin-top:40px;">
  <h2 style="margin-bottom:16px;">Descarga Amazon Prime para una mejor c√°lidad y variedad</h2>

  <div class="carousel-container">
    <div class="carousel-track" id="galleryCarousel"></div>

    <button class="carousel-btn prev" id="galleryPrev">‚ùÆ</button>
    <button class="carousel-btn next" id="galleryNext">‚ùØ</button>
  </div>
</section>

<script>
// =============================
// ‚≠ê CARRUSEL AMAZON PRIME
// =============================
const galleryTrack = document.getElementById("galleryCarousel");

// Usar PRIME_MOVIES desde publicidad.js
PRIME_MOVIES.forEach(m => {
  const item = document.createElement("div");
  item.className = "carousel-item prime-card";

  item.innerHTML = `
    <img src="${m.image}" alt="${m.title}">
    
    <div class="prime-info">
      <strong class="prime-title">${m.title}</strong>
      <p class="prime-sub">Disponible en Amazon Prime</p>

      <button class="prime-btn" onclick="window.open('${m.link}', '_blank')">
        Ver m√°s
      </button>
    </div>
  `;

  galleryTrack.appendChild(item);
});

</script>

<!-- === FOOTER === -->
<footer>
¬© 2025 Share Films ‚Äî Todos los derechos reservados.<br>
| <a href="https://whatsapp.com/channel/0029VbBtBvR2UPBOALdRU71t" target="_blank">WhatsApp Channelü™Ä</a>| ¬∑ |
<a href="https://chat.whatsapp.com/HesN0nsEOeN0PbAJFevL37?mode=wwt" target="_blank">WhatsApp Groupü™Ä</a>| ¬∑ |
<a href="https://apeiros173.github.io/ZonaDeportiva.com/">Zona Deportiva</a>| ¬∑ |
<a href="https://apeiros173.github.io/ShareFilms-Peliculas-Gratis/">Share Films 1 - Prototipo</a>| ¬∑ |
<a href="https://sharefilmsoficial-arch.github.io/PrimeFilms/" target="_blank">Share Films 2 - PrimeFilms </a>| ¬∑ |
<a href="https://sharefilmsoficial-arch.github.io/ShareFilms3.PeliculasGratis/" target="_blank">Share Films 3.0</a>|
</footer>
</body>
</html>
