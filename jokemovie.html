<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PelÃ­cula</title>
<link rel="stylesheet" href="style.css">
</head>
<body class="movie-page">
<div id="app">
  <div class="back-btn"><a href="javascript:history.back()">â† Volver</a></div>
  <div class="movie-hero" id="hero">
    <div id="videoContainer">

      <video id="bgVideo" autoplay muted playsinline></video>
    </div>


    <div class="overlay"></div>
    <div class="controls">
      <h1 id="title"></h1>
      <p id="meta"></p>
      <p id="description" style="margin-top:12px;opacity:0.85;font-size:16px;"></p>
      <div class="action-row">
        <button id="playMovie" class="big">Reproducir pelÃ­cula</button>
        <div class="small-controls">
          <button id="likeBtn" class="icon">ğŸ‘ <span id="likeCount">0</span></button>
          <button id="dislikeBtn" class="icon">ğŸ‘ <span id="dislikeCount">0</span></button>
          <button id="playTrailerBtn" class="icon">â–¶TrÃ¡iler</button>
          <button id="toggleMute" class="icon">ğŸ”‡</button>
        </div>
      </div>
    </div>\
  </div>
</div>

<script src="movies.js"></script>
<script>
/* user id */
const userId = localStorage.getItem("sf_user_id") || ('u_' + Math.random().toString(36).slice(2));
localStorage.setItem("sf_user_id", userId);

function qs(q){return document.querySelector(q);}
function qsa(q){return document.querySelectorAll(q);}

const params = new URLSearchParams(location.search);
const id = params.get('id');
const movie = MOVIES.find(m=>m.id===id);
if(!movie){
  document.body.innerHTML = '<p>Pelicula no encontrada. <a href="javascript:history.back()">â†Volver</a></p>';
  throw new Error('Movie not found');
}

qs('#title').textContent = movie.title;
qs('#meta').textContent = `${movie.year || ''} â€¢ ${movie.duration || ''} â€¢ ${movie.rating || ''}`;
qs('#description').textContent = movie.description || "Sin descripciÃ³n disponible.";

// ğŸ¬ Reproducir trÃ¡iler de fondo automÃ¡ticamente a los 5 segundos
setTimeout(() => {
  if (!movie.trailerUrl) return;

  const bgVideo = document.getElementById("bgVideo");

  bgVideo.src = movie.trailerUrl;
  bgVideo.muted = true;

  bgVideo.load();
  bgVideo.play().catch(e => console.warn("Autoplay bloqueado:", e));

  // ğŸ”¥ Cuando el trÃ¡iler de fondo termine, NO volver a reproducirlo
  bgVideo.onended = () => {
    bgVideo.pause();
    bgVideo.currentTime = 0;
  };

}, 6000);

// â–¶ BotÃ³n para reproducir SOLO el trÃ¡iler de fondo
const playTrailerBtn = document.getElementById("playTrailerBtn");

playTrailerBtn.addEventListener("click", () => {

  if (!movie.trailerUrl) return;

  const bgVideo = document.getElementById("bgVideo");

  bgVideo.src = movie.trailerUrl;
  bgVideo.muted = false;   // si quieres que salga con sonido
  bgVideo.currentTime = 0; // reiniciar desde el inicio
  bgVideo.play();

  // Cuando termine NO se reproduce de nuevo automÃ¡ticamente
  bgVideo.onended = () => {
    bgVideo.pause();
    bgVideo.currentTime = 0;
  };
});

// ğŸ¬ Imagen estÃ¡tica de fondo (sin trÃ¡iler)
const hero = qs('#hero');

if (movie.post) {
  hero.style.backgroundImage = `url(${movie.post})`;
  hero.style.backgroundSize = "cover";
  hero.style.backgroundPosition = "center";
} else {
  hero.classList.add('no-video');
}
// ğŸ”‡ BotÃ³n de mute/unmute//

toggleMute.addEventListener('click', () => {
  if (bgVideo.muted) {
    bgVideo.muted = false;
    toggleMute.textContent = 'ğŸ”Š';
  } else {
    bgVideo.muted = true;
    toggleMute.textContent = 'ğŸ”‡';
  }
});


// â–¶ Reproducir pelÃ­cula
qs('#playMovie').addEventListener('click', ()=>{
  if(movie.movie && movie.movie.startsWith('http')){
    window.open(movie.movie, '_blank');
  } else {
    alert('PelÃ­cula no disponible.');
  }
});

//ğŸ‘ğŸ‘ Likes y dislikes
const likeBtn = qs('#likeBtn');
const dislikeBtn = qs('#dislikeBtn');
const likeCountEl = qs('#likeCount');
const dislikeCountEl = qs('#dislikeCount');

let state = { userVote: 0 }; // 1=like, -1=dislike, 0=none

async function fetchVotes(){
  try{
    const res = await fetch(`api/get_votes.php?id=${movie.id}`);
    const data = await res.json();
    likeCountEl.textContent = data.likes || 0;
    dislikeCountEl.textContent = data.dislikes || 0;
    // get user's vote
    const r2 = await fetch(`api/get_user_vote.php?id=${movie.id}&user=${userId}`);
    const uv = await r2.json();
    state.userVote = uv.vote || 0;
    applyVoteVisual();
  }catch(e){
    console.error(e);
  }
}
function applyVoteVisual(){
  if(state.userVote===1){ likeBtn.classList.add('active'); dislikeBtn.classList.remove('active'); }
  else if(state.userVote===-1){ dislikeBtn.classList.add('active'); likeBtn.classList.remove('active'); }
  else { likeBtn.classList.remove('active'); dislikeBtn.classList.remove('active'); }
}
async function sendVote(vote){
  try{
    const res = await fetch('api/vote.php', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ movie_id: movie.id, user: userId, vote })
    });
    const data = await res.json();
    likeCountEl.textContent = data.likes;
    dislikeCountEl.textContent = data.dislikes;
    state.userVote = vote;
    applyVoteVisual();
  }catch(e){ console.error(e); }
}
likeBtn.addEventListener('click', ()=>{ state.userVote===1 ? sendVote(0) : sendVote(1); });
dislikeBtn.addEventListener('click', ()=>{ state.userVote===-1 ? sendVote(0) : sendVote(-1); });

fetchVotes();
</script>

<hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin:20px 32px;">
<section class="comments" id="commentsSection" style="padding:0 32px 40px;max-width:900px">
  <h2>Comentarios</h2>
  <div id="commentsList" aria-live="polite"></div>
  <div style="margin-top:12px">
    <input id="commentName" placeholder="Tu nombre (opcional)" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);width:40%;margin-right:8px" />
    <textarea id="commentText" placeholder="Deja un comentario..." style="width:100%;min-height:72px;margin-top:8px;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06)"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="submitComment" class="big">Comentar</button>
      <button id="clearComments" class="icon">ğŸ§¹ Limpiar</button>
    </div>
  </div>
</section>

<script>
const commentsList = document.getElementById('commentsList');
const commentName = document.getElementById('commentName');
const commentText = document.getElementById('commentText');
const submitComment = document.getElementById('submitComment');
const clearComments = document.getElementById('clearComments');

commentName.value = localStorage.getItem('sf_user_name') || '';

async function loadComments(){
  try{
    const res = await fetch(`api/get_comments.php?id=${movie.id}`);
    const data = await res.json();
    commentsList.innerHTML = '';
    if(!data || data.length===0){
      commentsList.innerHTML = '<p style="opacity:0.7">Sin comentarios. SÃ© el primero.</p>';
      return;
    }
    data.forEach(c=>{
      const el = document.createElement('div');
      el.className = 'comment';
      el.style.padding='8px 12px';
      el.style.borderRadius='8px';
      el.style.marginBottom='8px';
      el.style.background='rgba(255,255,255,0.02)';
      el.innerHTML = `
<strong>Usuario #${escapeHtml(c.usuario_id)}</strong>
<span style="opacity:0.6;font-size:12px;margin-left:8px">${escapeHtml(c.fecha)}</span>
<div style="margin-top:6px">${escapeHtml(c.comentario)}</div>`;

      commentsList.appendChild(el);
    });
  }catch(e){ console.error(e); }
}
function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

submitComment.addEventListener('click', async ()=>{
  const name = commentName.value.trim();
  const text = commentText.value.trim();
  if(!text){ alert('Escribe un comentario'); return; }
  localStorage.setItem('sf_user_name', name);
  try{
    const res = await fetch('api/add_comment.php', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({movie_id: movie.id, name, text})
    });
    const data = await res.json();
    if(data.success){ commentText.value=''; loadComments(); }
    else { alert('No se pudo guardar el comentario'); }
  }catch(e){ console.error(e); alert('Error al enviar'); }
});

clearComments.addEventListener('click', async ()=>{
  if(!confirm('Â¿Eliminar todos los comentarios de esta pelÃ­cula? (solo recomendado para pruebas)')) return;
  try{
    const res = await fetch('api/clear_comments.php', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({movie_id: movie.id})
    });
    const data = await res.json();
    if(data.success) loadComments();
  }catch(e){ console.error(e); }
});

loadComments();
</script>
<footer>
Â© 2025 Share Films â€” Todos los derechos reservados.<br>
<a href="https://whatsapp.com/channel/0029VbBtBvR2UPBOALdRU71t" target="_blank">WhatsApp ChannelğŸª€</a> Â·
<a href="https://chat.whatsapp.com/HesN0nsEOeN0PbAJFevL37?mode=wwt" target="_blank">WhatsApp GroupğŸª€</a> Â·
<a hreft="https://apeiros173.github.io/ZonaDeportiva.com/">Zona Deportiva</a> Â·
<a href="https://apeiros173.github.io/ShareFilms-Peliculas-Gratis/">Share Films 1 - Prototipo</a> Â·
<a href="https://sharefilmsoficial-arch.github.io/PrimeFilms/" target="_blank">Share Films 2 - PrimeFilms </a> Â· 
<a href="https://sharefilmsoficial-arch.github.io/ShareFilms3.PeliculasGratis/" target="_blank">Share Films 3.0</a>
</footer>

</body>
</html>